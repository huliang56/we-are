var cropbox=function(k){var a=document.querySelector(k.imageBox),d={state:{},ratio:1,range:0.05,maxRatio:5,minRatio:0.1,options:k,imageBox:a,thumbBox:a.querySelector(k.thumbBox),image:new Image(),getDataURL:function(){var o=this.thumbBox.clientWidth,u=this.thumbBox.clientHeight,p=document.createElement("canvas"),r=a.style.backgroundPosition.split(" "),w=a.style.backgroundSize.split(" "),x=parseInt(r[0])-a.clientWidth/2+o/2,v=parseInt(r[1])-a.clientHeight/2+u/2,m=parseInt(w[0]),s=parseInt(w[1]),q=parseInt(this.image.height),t=parseInt(this.image.width);p.width=o;p.height=u;var n=p.getContext("2d");n.drawImage(this.image,0,0,t,q,x,v,m,s);var l=p.toDataURL("image/png");return l},getBlob:function(){var p=this.getDataURL();var m=p.replace("data:image/png;base64,","");var o=atob(m);var n=[];for(var l=0;l<o.length;l++){n.push(o.charCodeAt(l))}return new Blob([new Uint8Array(n)],{type:"image/png"})},zoomIn:function(){this.ratio=this.ratio*(1+d.range);i()},zoomOut:function(){this.ratio=this.ratio*(1-d.range);i()}},e=function(n,m,l){if(n.attachEvent){n.attachEvent("on"+m,l)}else{if(n.addEventListener){n.addEventListener(m,l)}}},g=function(n,m,l){if(n.detachEvent){n.detachEvent("on"+m,l)}else{if(n.removeEventListener){n.removeEventListener(m,render)}}},c=function(l){if(window.event){l.cancelBubble=true}else{l.stopImmediatePropagation()}},i=function(){var l=parseInt(d.image.width)*d.ratio;var n=parseInt(d.image.height)*d.ratio;var m=(a.clientWidth-l)/2;var o=(a.clientHeight-n)/2;a.setAttribute("style","background-image: url("+d.image.src+"); "+"background-size: "+l+"px "+n+"px; "+"background-position: "+m+"px "+o+"px; "+"background-repeat: no-repeat")},b=function(l){c(l);d.state.dragable=true;d.state.mouseX=l.clientX;d.state.mouseY=l.clientY},h=function(o){c(o);if(d.state.dragable){var m=o.clientX-d.state.mouseX;var q=o.clientY-d.state.mouseY;var n=a.style.backgroundPosition.split(" ");var l=m+parseInt(n[0]);var p=q+parseInt(n[1]);a.style.backgroundPosition=l+"px "+p+"px";d.state.mouseX=o.clientX;d.state.mouseY=o.clientY}},j=function(l){c(l);d.state.dragable=false},f=function(l){l=window.event||l;var m=l.detail?l.detail*(-120):l.wheelDelta;if(m>-120){if(d.ratio>d.maxRatio){return false}d.ratio=(d.ratio*(1+d.range)).toFixed(3)}else{if(d.ratio<d.minRatio){return false}d.ratio=(d.ratio*(1-d.range)).toFixed(3)}i()};d.image.onload=function(){i();e(a,"mousedown",b);e(a,"mousemove",h);e(document.body,"mouseup",j);var l=(/Firefox/i.test(navigator.userAgent))?"DOMMouseScroll":"mousewheel";e(a,l,f)};d.image.src=k.imgSrc;e(a,"DOMNodeRemoved",function(){g(document.body,"DOMNodeRemoved",j)});return d};
